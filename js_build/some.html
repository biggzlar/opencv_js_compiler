<!DOCTYPE html>
<html lang="en">
	<head>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>OpenCV JS Binding - Image Processing Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
			}
			#showcase {
				margin: auto;
				display: flex;
				align-items: center;
			}
	    canvas {
				background-color: #F1F1F1;
			}
			#input-container {
				margin: auto;
			}
			a {
				color: #0040ff;
			}
		</style>
	</head>
	<body>
		<div id="wrapper">
			<div class="row">
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<a href='#' onclick='downloadCSV({ filename: "OpenCV_img_proc_results.csv" });'>Download CSV</a>
					<a id="downloadLnk" download="YourFileName.jpg">Download processed images</a>
			    <div class="emscripten">
			      <progress value="0" max="100" id="progress" hidden=1></progress>
			    </div>
				</div><!--col-8-->
				<div class="col-sm-4"></div>
			</div> <!--ROW-->
			<div class="row">
				<div id="input-container" class="col-sm-4">
					<input type="file" id="input" name="file" />
					<input type="button" id="function" value="c++ runner" onclick="cpp_test();" />
				</div>
				<div class="col-sm-4">
					<div id="showcase">
						<div>
					    <canvas id="canvas1" width="600" height="400"></canvas>
							<canvas id="canvas2" width="600" height="400"></canvas>
						</div>
					</div>
				</div><!--col-8-->
				<div class="col-sm-4"></div>
			</div> <!--ROW-->
		</div>

		<script src='dat.gui.js'></script>
		<script async src='cv.js'></script>
		<script type='text/javascript'>
			var Module = {};
		</script>

	  <script>
			function cpp_test(){
				Module.cool();
				console.log("put_picture returns *img.data: " + Module.put_picture());

				var canvas = document.getElementById("canvas1");
				var context = canvas.getContext("2d");
				var data = context.getImageData(0,0,canvas.width,canvas.height);
				var imdata = context.createImageData(canvas.width, canvas.height);
				var new_data = Module.mat_stuff(canvas.width, canvas.height, String(data.data));//JSON.parse("[" + Module.mat_stuff(canvas.width, canvas.height, String(data.data)) + "]");
				console.log("new_data from Module.mat_stuff(): " + new_data);
				for (var i = 0, j = 0; i < new_data; i += 24, j +=4){
					imdata.data[j] = new_data[i];
					imdata.data[j + 1] = new_data[i+1%24];
					imdata.data[j + 2] = new_data[i+2%24];
					imdata.data[j + 3] = 255;
				}
				console.log(imdata.width);
				console.log(imdata.height);
				console.log(imdata.data);
				//context.putImageData(imdata, 0, 0);
			}

			function show_image(mat, canvas_id) {
				var data = mat.data(); 	// output is a Uint8Array that aliases directly into the Emscripten heap

				channels = mat.channels();
				channelSize = mat.elemSize1();

				var canvas = document.getElementById(canvas_id);

				ctx = canvas.getContext("2d");
				ctx.clearRect(0, 0, canvas.width, canvas.height);

				canvas.width = mat.cols;
				canvas.height = mat.rows;

				imdata = ctx.createImageData(mat.cols, mat.rows);

				for (var i = 0,j=0; i < data.length; i += channels, j+=4) {
					imdata.data[j] = data[i];
					imdata.data[j + 1] = data[i+1%channels];
					imdata.data[j + 2] = data[i+2%channels];
					imdata.data[j + 3] = 255;
				}
				ctx.putImageData(imdata, 0, 0);
			}
	    function getInput() {
	      var canvas = document.getElementById('canvas1');
	      var ctx = canvas.getContext('2d');
	      var imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
	      return imgData;
	    }

	    var inputElement = document.getElementById("input");
			inputElement.addEventListener("change", handleFiles, false);
			function handleFiles(e) {
				var canvas = document.getElementById('canvas1');
				var canvasWidth = 600 ;
				var canvasHeight = 400 ;
				var ctx = canvas.getContext('2d');
				var url = URL.createObjectURL(e.target.files[0]);
				var img = new Image();
				img.onload = function() {
				//ctx.drawImage(img, 20, 20);

					var scaleFactor=Math.min((canvasWidth/img.width),(canvasHeight/img.height));
					canvas.width = img.width*scaleFactor ;
					canvas.height = img.height*scaleFactor ;
					ctx.drawImage(img,0,0,img.width*scaleFactor,img.height*scaleFactor);
				}
				img.src = url;
			}
		</script>
  </body>
</html>
