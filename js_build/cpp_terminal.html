<!DOCTYPE html>
<html lang='en'>
	<head>
    <script src='http://code.jquery.com/jquery-latest.min.js'></script>
		<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' integrity='sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u' crossorigin='anonymous'>
		<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
		<title>OpenCV JS Binding - Image Processing Demo</title>
		<meta charset='utf-8'>
		<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
		<style>
			body {
				font-family: Monospace;
				font-size: 12px;
			}
			input {
				appearance: none;
				-webkit-appearance: none;
			}
			a {
				color: #0040ff;
			}
			canvas {
				background-color: #F1F1F1;
			}
			#showcase {
				margin: auto;
				display: flex;
				align-items: center;
			}
			#input-container {
				margin-left: 20px;
			}
		</style>
	</head>
	<body>
		<div id='wrapper'>
			<div class='row'>
				<div class='col-sm-4'></div>
				<div class='col-sm-4'>
					<a href='#' onclick='downloadCSV({ filename: 'OpenCV_img_proc_results.csv' });'>Download CSV</a>
					<a id='downloadLnk' download='YourFileName.jpg'>Download processed images</a>
			    <div class='emscripten'>
			      <progress value='0' max='100' id='progress' hidden=1></progress>
			    </div>
				</div><!--col-8-->
				<div class='col-sm-4'></div>
			</div> <!--ROW-->
			<div class='row'>
				<div class='col-sm-4'>
					<div id='input-container'>
						<input type='file' id='input' name='file' /> <br>
						<input type='button' value='threshold' onclick='opencv_threshold();' /> <br>
						<input type='button' value='blur' onclick='opencv_blur();' />
					</div>
				</div>
				<div class='col-sm-4'>
					<div id='showcase'>
						<div>
					    <canvas id='canvas1' width='400' height='300'></canvas>
							<canvas id='canvas2' width='400' height='300'></canvas>
						</div>
					</div>
				</div><!--col-8-->
				<div class='col-sm-4'></div>
			</div> <!--ROW-->
		</div>

		<script src='dat.gui.js'></script>
		<script async src='cv.js'></script>
		<script type='text/javascript'>
			var Module = {};
		</script>

	  <script>
			function opencv_threshold(){
				var canvas = document.getElementById('canvas1');
				var context = canvas.getContext('2d');
				var data = context.getImageData(0,0,canvas.width,canvas.height);

				var canvas2 = document.getElementById('canvas2');
				var context2 = canvas2.getContext('2d');
				var imdata2 = context2.createImageData(document.getElementById('canvas1').width, document.getElementById('canvas1').height);
				canvas2.width = imdata2.width;
				canvas2.height = imdata2.height;
				var new_data2 = Module.js_threshold(imdata2.height, imdata2.width, String(data.data)).split(',').map(function(item){
					return parseInt(item, 10);
				});
				for (var i = 0; i < imdata2.data.length; i++){
					imdata2.data[i] = new_data2[i];
				}
				context2.putImageData(imdata2, 0, 0);
			}
			function opencv_blur(){
				var canvas = document.getElementById('canvas1');
				var context = canvas.getContext('2d');
				var data = context.getImageData(0,0,canvas.width,canvas.height);

				var canvas2 = document.getElementById('canvas2');
				var context2 = canvas2.getContext('2d');
				var imdata2 = context2.createImageData(document.getElementById('canvas1').width, document.getElementById('canvas1').height);
				canvas2.width = imdata2.width;
				canvas2.height = imdata2.height;
				var new_data2 = Module.js_blur(imdata2.height, imdata2.width, String(data.data)).split(',').map(function(item){
					return parseInt(item, 10);
				});
				for (var i = 0; i < imdata2.data.length; i++){
					imdata2.data[i] = new_data2[i];
				}
				context2.putImageData(imdata2, 0, 0);
			}

	    function getInput() {
	      var canvas = document.getElementById('canvas1');
	      var ctx = canvas.getContext('2d');
	      var imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
	      return imgData;
	    }

	    var inputElement = document.getElementById('input');
			inputElement.addEventListener('change', handleFiles, false);
			function handleFiles(e) {
				var canvas = document.getElementById('canvas1');
				var canvasWidth = 600 ;
				var canvasHeight = 400 ;
				var ctx = canvas.getContext('2d');
				var url = URL.createObjectURL(e.target.files[0]);
				var img = new Image();
				img.onload = function() {

					var scaleFactor=Math.min((canvasWidth/img.width),(canvasHeight/img.height));
					canvas.width = img.width*scaleFactor; //*scaleFactor
					canvas.height = img.height*scaleFactor; //*scaleFactor
					ctx.drawImage(img,0,0,img.width*scaleFactor,img.height*scaleFactor); //*scaleFactor *scaleFactor
				}
				img.src = url;
			}
		</script>
  </body>
</html>
